<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background-color: #0d0d0d;">
    <div class="container-fluid">
      <button type="button" class="btn btn-dark" href="#" onclick="logout()"><span style="color: rgb(0, 8, 255);">Logout</span></button>
    </div>
      
  </nav>
  <div class="container mt-5">
    <br><h2>User Profile:</h2><br><br>
   <section class="section about-section gray-bg" id="about">
      <div class="container">
        <div class="row  ">
          
          <div class="col-lg-6"><img
            src="https://bootdey.com/img/Content/avatar/avatar7.png"
            title=""
            alt=""
          /></div>
                    <div class="col-lg-6" id="user-profile">
                    </div>
                      </div>
          
        </div>
        <br />
        <div class="counter col-lg-4">
          <div class="row">
            <div class="col-6 col-lg-3">
              <div class="count-data text-center">
                <!-- Button trigger modal 1 -->
                <button
                  type="button"
                  class="btn btn-primary"
                  id="followersButton"
                  data-bs-toggle="modal"
                  data-bs-target="#exampleModal1"
                >
                  Followers
                </button>

                <!-- Modal 1 -->
                <div
                  class="modal fade"
                  id="exampleModal1"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel1"
                  aria-hidden="true"
                >
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel1">
                          Followers
                        </h5>
                        <button
                          type="button"
                          class="btn-close"
                          data-bs-dismiss="modal"
                          aria-label="Close"
                        ></button>
                      </div>
                      <div class="modal-body" id="modal-body1">Followers</div>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6 col-lg-3"></div>
            <div class="col-6 col-lg-3">
              <div class="count-data text-center">
                <!-- Button trigger modal 2 -->
                <button
                  type="button"
                  class="btn btn-primary"
                  id="followingButton"
                  data-bs-toggle="modal"
                  data-bs-target="#exampleModal2"
                >
                  Following
                </button>

                <!-- Modal 2 -->
                <div
                  class="modal fade"
                  id="exampleModal2"
                  tabindex="-1"
                  aria-labelledby="exampleModalLabel2"
                  aria-hidden="true"
                >
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel2">
                          Following
                        </h5>
                        <button
                          type="button"
                          class="btn-close"
                          data-bs-dismiss="modal"
                          aria-label="Close"
                        ></button>
                      </div>
                      <div class="modal-body" id="modal-body"></div>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Close
                        </button>
                      
                      </div>
                      
                    </div>
                    
                  </div>
                  
                </div>
                
              </div>
              
            </div>
            
          </div>
        
        </div>
        <h1>User Account Management</h1>

        <h2>Update User Data</h2>
        <div id="update-user-form">
          <label for="username">Username:</label>
          <input type="text" id="username" placeholder="Enter new username"><br><br>
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="Enter new email"><br><br>
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter new password"><br><br>
          <button id="update-user-btn">Update Data</button>
        </div>
        <h2>Delete Account</h2>
        <div id="delete-account-form">
          <label for="delete-confirm">Type 'DELETE' to confirm:</label>
          <input type="text" id="delete-confirm" placeholder="Type 'DELETE'"><br><br>
          <button id="delete-account-btn">Delete Account</button>
        </div>
        <div id="message"></div>
  
    <div id="follow-unfollow">
      <!-- Follow/Unfollow buttons and form go here -->
    </div>
    <h3>Create a New Post</h3>
<div>
  <textarea id="post-content" rows="4" cols="50" placeholder="Write your post here..."></textarea>
</div>
<button class="btn btn-primary" onclick="createPost()">Post</button>
  </div>
  <div id="posts-container"></div>
      </div>
    </section>

  

  

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

  <script>
    const profileEndpoint = '/profile';
    const followEndpoint = '/follow/';
    const unfollowEndpoint = '/unfollow/';
  
    const fetchUserProfile = async () => {
      try {
        const response = await fetch(profileEndpoint);
        if (!response.ok) {
          throw new Error(`Error fetching user profile. Status: ${response.status}`);
        }

        const user = await response.json();
        const userProfileDiv = document.getElementById('user-profile');
        userProfileDiv.innerHTML = `
          <p>Username: ${user.username}</p>
          <p>Email: ${user.email}</p>
          <p>Followers: ${user.followers}</p>
          <p>Following: ${user.following}</p>
          <button class="btn btn-primary" onclick="handleFollowButtonClick(${user.id}, '${followEndpoint}')">Follow</button>
          <button class="btn btn-danger" onclick="handleFollowButtonClick(${user.id}, '${unfollowEndpoint}')">Unfollow</button>
        `;

        // Fetch and display the list of other users
        fetchOtherUsers();
      } catch (error) {
        console.error('Error fetching user profile:', error);
      }
    };
    const fetchOtherUsers = async () => {
      try {
        const response = await fetch('/users');
        if (!response.ok) {
          throw new Error(`Error fetching users. Status: ${response.status}`);
        }

        const users = await response.json();
        const followUnfollowDiv = document.getElementById('follow-unfollow');
        followUnfollowDiv.innerHTML = `
          <h3>Follow/Unfollow</h3>
          <ul>
            ${users.map((user) => `
              <li>${user.username} - 
                ${user.isFollowing
                  ? `<button class="btn btn-danger" onclick="handleFollowButtonClick(${user.id}, '${unfollowEndpoint}')">Unfollow</button>`
                  : `<button class="btn btn-primary" onclick="handleFollowButtonClick(${user.id}, '${followEndpoint}')">Follow</button>`}
              </li>`).join('')}
          </ul>
        `;
      } catch (error) {
        console.error('Error fetching users:', error);
      }
    };
    document.addEventListener('DOMContentLoaded', () => {
  const followersButton = document.querySelector('#followersButton');
  const followingButton = document.querySelector('#followingButton')
  followersButton.addEventListener('click', () => {
    console.log("Button clicked");
    fetchFollowers();
  });
   followingButton.addEventListener('click', () => {
    console.log("Button clicked");
    fetchFollowing();
});
});

    const fetchFollowers = async (userId) => {
  try {
    console.log("Fetching followers");
    const response = await fetch(`http://localhost:3000/followers/${userId}`);
    if (!response.ok) {
      throw new Error(`Error fetching followers. Status: ${response.status}`);
    }

    const followersData = await response.json();
    console.log("Followers data:", followersData);
    const followersModalBody = document.querySelector('.modal-body');

    // Clear the modal body content before adding new data
    followersModalBody.innerHTML = '';

    // Add each follower to the modal body
    followersData.forEach(follower => {
      followersModalBody.innerHTML += `<p>${follower.username}</p>`;
    });
  } catch (error) {
    console.error('Error fetching followers:', error);
  }
};

const fetchFollowing = async (userId) => {
  try {
    console.log("Fetching followings");
    const response = await fetch(`http://localhost:3000/following/${userId}`);
    if (!response.ok) {
      throw new Error(`Error fetching following. Status: ${response.status}`);
    }

    const followingData = await response.json();
    console.log("Following data:", followingData);
    const followingModalBody = document.querySelector('.modal-body');

    // Clear the modal body content before adding new data
    followingModalBody.innerHTML = '';

    // Add each following user to the modal body
    followingData.forEach(following => {
      followingModalBody.innerHTML += `<p>${following.username}</p>`;
    });
  } catch (error) {
    console.error('Error fetching following:', error);
  }
};


const fetchUserPosts = async () => {
  
};
const createPost = async () => {
  try {
    const postContent = document.getElementById('post-content').value;

    const response = await fetch('/post', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: postContent }),
    });

    if (!response.ok) {
      throw new Error(`Error creating post. Status: ${response.status}`);
    }

    const newPost = await response.json();
    console.log(`Post created successfully: ${newPost.content}`);
    
    // Optionally, you can fetch and update the user's posts after creating a new post
    fetchUserPosts();
  } catch (error) {
    console.error('Error creating post:', error);
  }
};

document.addEventListener('DOMContentLoaded', () => {
  fetchUserProfile();
  fetchUserPosts(); // Add this line to fetch user posts on page load
});


const handleFollowButtonClick = async (userId, action) => {
      try {
        const response = await fetch(`${action}${userId}`, { method: 'POST' });
        if (!response.ok) {
          throw new Error(`Error ${action} user. Status: ${response.status}`);
        }

        const result = await response.json();

        // Display information about the user followed or unfollowed
        console.log(result.message);

        // Update the user profile information and other users
        fetchUserProfile();
      } catch (error) {
        console.error(`Error ${action} user:`, error);
      }
    };
  
    document.addEventListener('DOMContentLoaded', () => {
      fetchUserProfile();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      try {
    fetch('/posts').then(response =>response.json()).then(posts=>{
      const postsContainer = document.getElementById('posts-container');
      const userPostContainer = document.createElement('div')
      posts.forEach(post=>{
        fetch(`/user/${post.user_id}`).then(response =>response.json()).then(user=>{
          
          userPostContainer.innerHTML+=`<div class="" style="margin:10px 100px; padding: 10px; border: 1px solid black"><p>${user.username} </p> 
                                        <p>${post.content} </p>
                                        <p>${post.created_at} </p></div>`
          
        })
        
      })
      postsContainer.appendChild(userPostContainer)
    })
  } catch (error) {
    console.error('Error fetching user posts:', error);
  }
    });







    document.addEventListener('DOMContentLoaded', () => {
      const updateUserForm = document.getElementById('update-user-form');
      const updateBtn = document.getElementById('update-user-btn');
      const deleteAccountForm = document.getElementById('delete-account-form');
      const deleteBtn = document.getElementById('delete-account-btn');
      const messageDiv = document.getElementById('message');

      updateBtn.addEventListener('click', async () => {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        try {
          const response = await fetch('/update-user', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, email, password })
          });

          if (!response.ok) {
            throw new Error('Error updating user data');
          }

          showMessage('User data updated successfully', 'success');
        } catch (error) {
          console.error(error);
          showMessage('Error updating user data', 'error');
        }
      });

      deleteBtn.addEventListener('click', async () => {
        const confirmInput = document.getElementById('delete-confirm').value.trim();
        if (confirmInput !== 'DELETE') {
          showMessage('Please type "DELETE" to confirm deletion', 'error');
          return;
        }

        try {
          const response = await fetch('/delete-account', {
            method: 'DELETE'
          });

          if (!response.ok) {
            throw new Error('Error deleting account');
          }

          showMessage('Account deleted successfully', 'success');
        } catch (error) {
          console.error(error);
          showMessage('Error deleting account', 'error');
        }
      });

      function showMessage(message, type) {
        messageDiv.textContent = message;
        messageDiv.className = type;
      }
    });


//logout
function logout() {
    fetch('/logout', {
      method: 'POST',
      credentials: 'same-origin' // Ensure cookies are sent along with the request
    })
    .then(response => {
      if (response.ok) {
        // Redirect to the login page or any other appropriate page after logout
        window.location.href = '/';
      } else {
        console.error('Error logging out');
        // Handle error case if needed
      }
    })
    .catch(error => {
      console.error('Error logging out:', error);
      // Handle error case if needed
    });
  }

  </script>
</body>
</html>
